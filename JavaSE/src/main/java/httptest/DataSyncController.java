package httptest;

import com.alibaba.fastjson.JSON;
import common.RedisUtil;
import org.apache.commons.lang3.time.FastDateFormat;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import utils.PolygonUtil;

import java.text.SimpleDateFormat;
import java.util.*;

/**
 * @program: DataSync
 * @description: 图盟数据对接
 * @author: mx
 * @create: 2021-04-08 09:47
 * @Modified By:
 * @Version: 1.0
 **/
@Configuration
@EnableScheduling
@RestController
@RequestMapping("/datadocking")
@EnableAsync
public class DataSyncController {

    private RestTemplate restTemplate;

    //区域经纬度
    private final String areaPath = "[[[119.322421,28.800908],[119.325327,28.811356],[119.342706,28.819869],[119.333583,28.834739],[119.334201,28.84437],[119.341141,28.846646],[119.336202,28.853687],[119.332654,28.853469],[119.326782,28.845187],[119.317485,28.846556],[119.311092,28.84244],[119.312337,28.857801],[119.320348,28.869599],[119.332568,28.864204],[119.336404,28.874251],[119.325828,28.883657],[119.340919,28.88152],[119.345607,28.8913],[119.34546,28.899741],[119.33378,28.907955],[119.315605,28.943212],[119.311486,28.959863],[119.304476,28.967561],[119.316633,28.970277],[119.328271,28.984186],[119.323593,28.989448],[119.325828,28.995145],[119.321176,29.003161],[119.327354,29.038069],[119.333537,29.02271],[119.336555,29.024115],[119.33239,29.04341],[119.33467,29.051642],[119.329625,29.055472],[119.327826,29.067127],[119.332532,29.075967],[119.322983,29.088405],[119.325618,29.091778],[119.354912,29.113757],[119.360811,29.1263],[119.387103,29.126048],[119.40049,29.146337],[119.404406,29.144767],[119.404302,29.137178],[119.410368,29.141123],[119.413751,29.136205],[119.428797,29.142796],[119.439023,29.138394],[119.442903,29.130412],[119.450074,29.130202],[119.445917,29.121908],[119.447371,29.114782],[119.452922,29.112124],[119.451857,29.11879],[119.454931,29.119433],[119.456679,29.110809],[119.467955,29.099861],[119.47928,29.096306],[119.490352,29.110711],[119.501654,29.110237],[119.499978,29.130032],[119.504544,29.133556],[119.539726,29.13167],[119.545484,29.139038],[119.545436,29.129406],[119.549676,29.131275],[119.557026,29.143446],[119.555736,29.148385],[119.564707,29.158767],[119.561937,29.165259],[119.566449,29.183985],[119.593368,29.209663],[119.59931,29.225454],[119.642688,29.222317],[119.710063,29.240742],[119.709054,29.229575],[119.703857,29.22694],[119.698765,29.22998],[119.696939,29.22245],[119.670277,29.220413],[119.650352,29.198706],[119.658018,29.198084],[119.660094,29.180907],[119.675748,29.139948],[119.667261,29.114743],[119.67471,29.102039],[119.663069,29.090764],[119.676202,29.07727],[119.671389,29.063683],[119.677271,29.04476],[119.691318,29.036868],[119.707675,29.041447],[119.717398,29.051775],[119.740558,29.045224],[119.742519,29.038781],[119.733351,29.02147],[119.738936,29.002341],[119.729728,28.996533],[119.736978,28.994717],[119.749814,28.998938],[119.758692,28.992274],[119.769938,28.995511],[119.760144,28.98774],[119.747904,28.987514],[119.74681,28.979156],[119.734763,28.975551],[119.730889,28.955145],[119.716861,28.94516],[119.72196,28.940551],[119.721178,28.936502],[119.695926,28.931829],[119.676505,28.916254],[119.654155,28.918844],[119.650781,28.89241],[119.636528,28.876569],[119.63247,28.863681],[119.627406,28.862983],[119.623351,28.868282],[119.611058,28.873087],[119.59354,28.840213],[119.576923,28.847803],[119.56199,28.837856],[119.556526,28.828344],[119.564396,28.81966],[119.562256,28.809105],[119.544121,28.789441],[119.540366,28.787252],[119.529925,28.790416],[119.525211,28.786778],[119.495858,28.747188],[119.499469,28.738227],[119.490405,28.729073],[119.473777,28.747835],[119.470845,28.765361],[119.463412,28.76643],[119.455786,28.761091],[119.433109,28.756607],[119.422819,28.749539],[119.416731,28.750122],[119.411709,28.763282],[119.387672,28.786931],[119.371892,28.784792],[119.369753,28.775373],[119.36039,28.769658],[119.358215,28.761036],[119.353337,28.757435],[119.341813,28.758407],[119.327168,28.781477],[119.328988,28.799909],[119.322421,28.800908]],[[119.819712,29.306752],[119.840258,29.298573],[119.841599,29.295923],[119.845442,29.295323],[119.857491,29.285022],[119.867404,29.285523],[119.870123,29.282974],[119.871854,29.277745],[119.875076,29.273252],[119.881599,29.272289],[119.884744,29.273596],[119.889492,29.273117],[119.890861,29.270106],[119.891381,29.260016],[119.892646,29.257989],[119.904064,29.254543],[119.908799,29.246956],[119.920738,29.246137],[119.923765,29.244259],[119.924338,29.240411],[119.922646,29.233797],[119.916874,29.226379],[119.915529,29.214304],[119.919772,29.208223],[119.92792,29.200991],[119.927815,29.195837],[119.92963,29.192145],[119.926495,29.185257],[119.931088,29.180543],[119.932958,29.176088],[119.938716,29.172074],[119.939711,29.151193],[119.941874,29.14864],[119.948608,29.145448],[119.948433,29.137254],[119.943784,29.130046],[119.943149,29.118247],[119.940038,29.115771],[119.921787,29.111905],[119.917864,29.109692],[119.918185,29.101545],[119.915416,29.097952],[119.916518,29.096517],[119.922437,29.09442],[119.922298,29.093151],[119.918288,29.089222],[119.916613,29.083894],[119.908137,29.082975],[119.90641,29.080238],[119.906514,29.075701],[119.907607,29.074094],[119.90961,29.0723],[119.914174,29.071991],[119.916048,29.070141],[119.911848,29.065468],[119.900512,29.057565],[119.901058,29.052632],[119.897139,29.050133],[119.895648,29.052211],[119.882753,29.051325],[119.874886,29.043814],[119.868512,29.03457],[119.862641,29.032833],[119.859048,29.030345],[119.852426,29.031824],[119.842636,29.027372],[119.834491,29.014825],[119.834715,29.009486],[119.83308,29.007891],[119.823845,29.006127],[119.811259,29.010696],[119.795051,29.008167],[119.788979,29.004945],[119.777317,29.002383],[119.77496,29.000849],[119.773617,28.996528],[119.769533,28.993025],[119.769938,28.995511],[119.76755,28.997242],[119.757884,28.992329],[119.754557,28.996361],[119.748325,28.99903],[119.738817,28.995049],[119.731641,28.995228],[119.730133,28.995908],[119.730151,28.997473],[119.738936,29.002341],[119.733351,29.02147],[119.735305,29.029195],[119.740183,29.034177],[119.742519,29.038781],[119.743022,29.041406],[119.741944,29.04421],[119.717398,29.051775],[119.714125,29.050691],[119.709907,29.046547],[119.709063,29.042451],[119.707675,29.041447],[119.691318,29.036868],[119.685581,29.038526],[119.676808,29.045596],[119.675373,29.056925],[119.671361,29.065095],[119.676202,29.07727],[119.673905,29.082481],[119.67064,29.085842],[119.663069,29.090764],[119.665077,29.091278],[119.673893,29.099281],[119.67471,29.102039],[119.673294,29.107694],[119.667261,29.114743],[119.667409,29.118225],[119.675791,29.137386],[119.675748,29.139948],[119.673974,29.14102],[119.674322,29.145785],[119.671384,29.150686],[119.669907,29.159633],[119.660094,29.180907],[119.661503,29.187151],[119.657044,29.191663],[119.658018,29.198084],[119.652559,29.197456],[119.650352,29.198706],[119.651169,29.201463],[119.661713,29.210587],[119.665304,29.217413],[119.674398,29.222306],[119.690342,29.224001],[119.696939,29.22245],[119.698765,29.22998],[119.699634,29.230359],[119.700764,29.228179],[119.703857,29.22694],[119.709054,29.229575],[119.710063,29.240742],[119.714017,29.246878],[119.72412,29.252235],[119.733273,29.253002],[119.744739,29.256447],[119.747568,29.261588],[119.748055,29.265369],[119.759722,29.272762],[119.771168,29.284564],[119.776125,29.284708],[119.789494,29.294248],[119.799298,29.297509],[119.802528,29.301157],[119.819712,29.306752]]]";

    @Autowired
    private RedisUtil redisUtils;

    private static final Logger log = LoggerFactory.getLogger(DataSyncController.class);
    public static final FastDateFormat ISO_DATE_FORMAT = FastDateFormat.getInstance("yyyy-MM-dd HH:mm:ss", Locale.CHINA);
    public static final SimpleDateFormat SIMPLE_DATE_FORMAT = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

    public DataSyncController(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    /**
     * 自定义区域指标查询
     */
    public void getImportantAreaInfo(String name, List<Object> areaReturnInfoList) {
        Map<String, String> importantAreaParam = new HashMap<>();
        importantAreaParam.put("type", "1");
        importantAreaParam.put("name", name);
        ResponseEntity<String> importantAreaResponse = restTemplate.getForEntity("http://41.232.129.192:27071/area/getRealAreaList?name={name}&type={type}", String.class, importantAreaParam);
        log.debug("调用'getRealAreaList',参数：[{}],接收到的数据为:[{}]", "type=1&name=" + name, importantAreaResponse.toString());
        if (importantAreaResponse.getStatusCode() == HttpStatus.OK) {
            String AreaInfoEntityCode = JSON.parseObject(importantAreaResponse.getBody()).getString("code");
            if ("1".equals(AreaInfoEntityCode)) {
                String resultObject = JSON.parseObject(importantAreaResponse.getBody()).getString("resultObject");
                resultObject = resultObject.substring(1, resultObject.length() - 1);
                Object areaReturnInfo = JSON.parseObject(resultObject, Object.class);
                List list = new ArrayList();
                //判断该条数据是否在金华区域内 否删除
                Iterator iterator = list.iterator();
                while (iterator.hasNext()) {
                    if (!PolygonUtil.isWithinRange(102.2, 90.8, areaPath)) {
                        iterator.remove();
                    }
                }
            } else {
                log.info("调用'getRealAreaList'接口失败！！！");
            }
        }
    }
}